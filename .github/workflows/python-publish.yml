name: Auto Build Release

on:
  push:
    tags:
      - 'v*'  # 使用v开头的tag触发
  workflow_dispatch: 

jobs:
  build-release:
    runs-on: windows-latest  # Windows环境用于生成exe
    
    steps:
    # 步骤1：检出当前仓库代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 步骤2：配置Python环境
    - name: Setup Python 3.10.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.9'
        architecture: 'x64'

    # 步骤3：安装依赖
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    # 步骤4：执行打包（假设spec文件在仓库根目录）
    - name: Build with PyInstaller
      run: |
        pyinstaller --noconfirm 自动脚本.spec
        
        # 调试用：显示生成目录结构
        Get-ChildItem -Path dist -Recurse | Format-Table -AutoSize

    # 步骤5：上传到Release
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          dist/**/*  # 包含所有子目录内容
        draft: false
        prerelease: false
